<html>

<head>
  <title>Game Sales Visualization</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    .axis text {
      font-size: 12px;
    }

    .gridlines line {
      stroke: #bbb;
      stroke-opacity: 0.7;
    }

    .gridlines .domain {
      stroke: none;
    }
    .legend{
      width:30px ;
      height:30px ;
    }
  </style>
</head>

<body>
  <p>
  <h3>Game Sales by Year, Genre, and Platform</h3>
  <svg id="salesChart" width="1000" height="600"></svg>
  </p>


  <script>

    const svg = d3.select("svg#salesChart");
    const width = svg.attr("width");
    const height = svg.attr("height");
    const margin = { top: 10, right: 20, bottom: 50, left: 100 };
    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom;

    let annotations = svg.append("g").attr("id", "annotations");
    let chartArea = svg.append("g").attr("id", "points")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    d3.csv("Filtered_Top_Games__2000_and_Earlier_.csv", d3.autoType).then(data => {
      console.log("dataset:", Object.keys(data[0]));
      //exten and scale
      const xExtent = d3.extent(data, d => d.Year);
      const xScale = d3.scaleLinear()
        .domain(xExtent)
        .range([0, chartWidth]);

      const yExtent = d3.map(data, d => d.Genre);
      const yScale = d3.scaleBand()
        .domain(yExtent)
        .range([chartHeight, 0])

      const sizeScale = d3.scaleSqrt()
        .domain([0, d3.max(data, d => d.Global_Sales)])
        .range([5, 40]);
      const colorScale = d3.scaleOrdinal(d3.schemeCategory10)
        .domain(data.map(d => d.Platform));
      //axis
        let bottomAxis = d3.axisBottom(xScale)
                .ticks(20)
        let bottomGridlines = d3.axisBottom(xScale)
                .ticks(20)
                .tickSize(-chartWidth - 10)
                .tickFormat("");


        let leftAxis = d3.axisLeft(yScale);
        let leftGridlines = d3.axisLeft(yScale)
                .tickSize(-chartWidth - 10)
                .tickFormat("");


            annotations.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(" + margin.left + "," + (chartHeight + margin.top + 10) + ")")
                .call(bottomAxis);

            annotations.append("g")
                .attr("class", "x gridlines")
                .attr("transform", "translate(" + margin.left + "," + (chartHeight + margin.top + 10) + ")")
                .call(bottomGridlines);

            annotations.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(" + (margin.left - 30) + "," + margin.top + ")")
                .call(leftAxis);

            annotations.append("g")
                .attr("class", "y gridlines")
                .attr("transform", "translate(" + (margin.left - 10) + "," + margin.top + ")")
                .call(leftGridlines);

      //circle
      chartArea.selectAll("circle")
        .data(data)
        .enter()
        .append("circle")
        .attr("cx", d => xScale(+d.Year))
        .attr("cy", d => yScale(d.Genre) + yScale.bandwidth() / 2)
        .attr("r", d => sizeScale(+d.Global_Sales) / 1.5)
        .attr("fill", d => colorScale(d.Platform))
        .attr("opacity", 0.7);

      //platform legend
       const platformLegend = d3.map(data,d=>d.Platform)
       const legend = svg.append("g")
          .attr("class", "legendGroup")
          .attr("transform", `translate(${width - margin.right - 150}, ${margin.top})`)
          .style("border", "1px solid black")  
          .style("background-color", "#f9f9f9"); 

      // Create legend items for each unique platform
      const legendItems = legend.selectAll(".legendItem")
        .data(platformLegend)
        .enter()
        .append("g")
        .attr("class", "legendItem")
        .attr("transform", (d, i) => `translate(0, ${i * 25})`); 

      // Append colored rectangles to represent each platform
      legendItems.append("rect")
        .attr("x", 0)
        .attr("width", 20)
        .attr("height", 20)
        .attr("fill", d => colorScale(d))
        .attr("opacity", 0.7);

      // Append text labels for each platform
      legendItems.append("text")
        .attr("x", 30)
        .attr("y", 15) // Center text vertically relative to the rectangles
        .attr("font-size", "12px")
        .attr("fill", "#000")  // Set text color for better visibility
        .text(d => d);
            console.log(legend);
            //  console.log(platformLegend);



    });
  </script>
</body>

</html>