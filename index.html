<!DOCTYPE html>
<html>
<head>
  <title>Game Sales Visualization</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    .axis text {
      font-size: 12px;
    }

    .gridlines line {
      stroke: #bbb;
      stroke-opacity: 0.7;
    }

    .gridlines .domain {
      stroke: none;
    }

    .axis-label {
      font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
      font-size: 20px;
      text-anchor: middle;
    }
  </style>
</head>

<body>
  <h3>Game Sales by Year, Genre, and Platform</h3>
  <svg id="salesChart" width="1000" height="1000"></svg>

  <script>
    const svg = d3.select("svg#salesChart");
    const width = svg.attr("width");
    const height = svg.attr("height");
    const margin = { top: 10, right: 20, bottom: 50, left: 130 };
    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom - 400;

    let annotations = svg.append("g").attr("id", "annotations");
    let chartArea = svg.append("g").attr("id", "points")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    d3.csv("Filtered_Top_Games__2000_and_Earlier_.csv", d3.autoType).then(data => {
      console.log("dataset:", Object.keys(data[0]));
      
      const xExtent = d3.extent(data, d => d.Year);
      const xScale = d3.scaleLinear()
        .domain(xExtent)
        .range([0, chartWidth]);

      const yExtent = d3.map(data, d => d.Genre);
      const yScale = d3.scaleBand()
        .domain(yExtent)
        .range([chartHeight, 0]);

      const sizeScale = d3.scaleSqrt()
        .domain([0, d3.max(data, d => d.Global_Sales)])
        .range([5, 40]);

      const imageMap = {
        "2600": "2600.png",
        "NES": "NES.png",
        "GB": "GB.png",
        "SNES": "SNES.png",
        "PS": "PS.png"
      };

      let bottomAxis = d3.axisBottom(xScale).ticks(20);
      let bottomGridlines = d3.axisBottom(xScale).ticks(20).tickSize(-chartWidth - 10).tickFormat("");
      let leftAxis = d3.axisLeft(yScale);
      let leftGridlines = d3.axisLeft(yScale).tickSize(-chartWidth - 10).tickFormat("");

      annotations.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(" + margin.left + "," + (chartHeight + margin.top + 10) + ")")
        .call(bottomAxis);

      annotations.append("g")
        .attr("class", "x gridlines")
        .attr("transform", "translate(" + margin.left + "," + (chartHeight + margin.top + 10) + ")")
        .call(bottomGridlines);

      annotations.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(" + (margin.left - 30) + "," + margin.top + ")")
        .call(leftAxis);

      annotations.append("g")
        .attr("class", "y gridlines")
        .attr("transform", "translate(" + (margin.left - 10) + "," + margin.top + ")")
        .call(leftGridlines);

      svg.append("text")
        .attr("class", "x axis-label")
        .attr("x", margin.left + chartWidth / 2)
        .attr("y", chartHeight + 80)
        .text("Year");

      svg.append("text")
        .attr("class", "y axis-label")
        .attr("x", -(chartHeight / 2) - margin.top)
        .attr("y", 20)
        .attr("transform", "rotate(-90)")
        .text("Game Genre");

      chartArea.selectAll("image")
        .data(data)
        .enter()
        .append("image")
        .attr("xlink:href", d => imageMap[d.Platform])
        .attr("x", d => xScale(+d.Year) - 20) 
        .attr("y", d => yScale(d.Genre) + yScale.bandwidth() / 2 - 20)
        .attr("width", d => sizeScale(+d.Global_Sales))
        .attr("height", d => sizeScale(+d.Global_Sales))
        .attr("opacity", 0.8);

      console.log(data);
    });
  </script>
</body>
</html>
